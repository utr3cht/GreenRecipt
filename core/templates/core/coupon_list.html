{% extends 'core/base.html' %}

{% block title %}所持クーポン一覧 | GreenReceipt{% endblock %}

{% block content %}


<div class="container">
  <h1>所持クーポン一覧</h1>

  {% if coupons %}
    <div class="coupon-grid">
      {% for coupon in coupons %}
        <div class="coupon-card"
             data-id="{{ coupon.id }}"
             data-title="{{ coupon.title }}"
             data-description="{{ coupon.description }}"
             data-discount="{% if coupon.discount_amount %}{{ coupon.discount_amount }}円引き{% else %}{{ coupon.discount_rate }}% OFF{% endif %}"
             data-requirement="{{ coupon.requirement }}"
             data-stores="{% for store in coupon.available_stores.all %}{{ store.store_name }}{% if not forloop.last %}, {% endif %}{% endfor %}"
             data-store-ids="{% for store in coupon.available_stores.all %}{{ store.store_id }}:{{ store.store_name }}{% if not forloop.last %},{% endif %}{% endfor %}">
          <h3>{{ coupon.title }}</h3>
          <p><strong>特典:</strong> {% if coupon.discount_amount %}{{ coupon.discount_amount }}円引き{% else %}{{ coupon.discount_rate }}% OFF{% endif %}</p>
          <p><strong>条件:</strong> {{ coupon.requirement }}</p>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="no-coupons">
      <p>現在、所持しているクーポンはありません。</p>
    </div>
  {% endif %}
</div>

<!-- モーダル本体 -->
<div id="couponModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modalTitle"></h2>
    </div>
    <div class="modal-body">
      <p id="modalDescription"></p>
      <p><strong>特典:</strong> <span id="modalDiscount"></span></p>
      <p><strong>ご利用条件:</strong> <span id="modalRequirement"></span></p>
      <p><strong>利用可能店舗:</strong> <span id="modalStores"></span></p>
      
      <div id="storeSelectionContainer" style="margin-top: 15px; display: none;">
        <label for="storeSelect">利用する店舗を選択してください:</label>
        <select id="storeSelect" class="form-control" style="width: 100%; padding: 8px; margin-top: 5px;">
          <option value="">店舗を選択...</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button id="useCouponBtn" class="use-button">このクーポンを使う</button>
      <button id="closeModalBtn" class="close-button">閉じる</button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const modal = document.getElementById('couponModal');
  const closeModalBtn = document.getElementById('closeModalBtn');
  const useCouponBtn = document.getElementById('useCouponBtn');

  // モーダルを閉じる処理
  const closeModal = () => {
    modal.style.display = 'none';
  };

  closeModalBtn.addEventListener('click', closeModal);
  window.addEventListener('click', (event) => {
    if (event.target === modal) {
      closeModal();
    }
  });

  // クーポンカードのクリックイベント
  document.querySelectorAll('.coupon-card').forEach(card => {
    card.addEventListener('click', function() {
      // If card is already used, do nothing
      if (this.classList.contains('used')) {
        return;
      }

      const id = this.dataset.id;
      const title = this.dataset.title;
      const description = this.dataset.description;
      const discount = this.dataset.discount;
      const requirement = this.dataset.requirement;
      const stores = this.dataset.stores;

      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalDescription').textContent = description;
      document.getElementById('modalDiscount').textContent = discount;
      document.getElementById('modalRequirement').textContent = requirement;
      
      const storesSpan = document.getElementById('modalStores');
      if (stores) {
        storesSpan.textContent = stores;
      } else {
        storesSpan.textContent = '全店舗で利用可能';
      }

      // 'use'ボタンにcoupon-idをセット
      useCouponBtn.dataset.couponId = id;

      // 店舗選択肢の生成
      const storeIdsStr = this.dataset.storeIds;
      const storeSelect = document.getElementById('storeSelect');
      const storeSelectionContainer = document.getElementById('storeSelectionContainer');
      
      storeSelect.innerHTML = '<option value="">店舗を選択...</option>';
      
      if (storeIdsStr) {
        const storesList = storeIdsStr.split(',');
        storesList.forEach(storeStr => {
          const [id, name] = storeStr.split(':');
          if (id && name) {
            const option = document.createElement('option');
            option.value = id;
            option.textContent = name;
            storeSelect.appendChild(option);
          }
        });
        
        if (storesList.length > 0) {
            storeSelectionContainer.style.display = 'block';
            // 1店舗しかない場合は自動選択
            if (storesList.length === 1) {
                storeSelect.selectedIndex = 1;
            }
        } else {
            storeSelectionContainer.style.display = 'none';
        }
      } else {
        // 利用可能店舗の指定がない場合（全店舗など）
        // ここでは単純化のため、選択なし（null）で送信するか、
        // あるいは全店舗リストを取得する必要があるが、現状は非表示にする
        storeSelectionContainer.style.display = 'none';
      }

      modal.style.display = 'block';
    });
  });

  // 「クーポンを使う」ボタンのクリックイベント
  useCouponBtn.addEventListener('click', () => {
    const couponId = useCouponBtn.dataset.couponId;
    if (!couponId) return;

    if (!confirm('このクーポンを使用しますか？使用後は元に戻せません。')) {
      return;
    }

    const url = `/coupons/use/${couponId}/`;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const storeId = document.getElementById('storeSelect').value;

    fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken,
      },
      body: JSON.stringify({
        store_id: storeId
      }),
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('クーポンを使用しました。');
        closeModal();
        
        // Mark the card as used instead of removing it
        const usedCard = document.querySelector(`.coupon-card[data-id='${couponId}']`);
        if (usedCard) {
          usedCard.classList.add('used');
        }

      } else {
        alert('エラーが発生しました: ' + (data.error || '不明なエラー'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('通信中にエラーが発生しました。');
    });
  });
});
</script>
{% endblock %}
