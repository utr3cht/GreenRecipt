{% extends 'core/base.html' %}

{% block content %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #map {
      height: 100vh;
      width: 100%;
      position: relative;
      z-index: 1;
    }
    .popup-content {
      font-size: 14px;
      line-height: 1.5;
    }
    .store-name {
      font-weight: bold;
      color: #007b3a;
    }
  </style>

  <div id="map"></div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    // --- åˆæœŸåœ°å›³è¨­å®š ---
    var map = L.map('map').setView([36.555, 139.882], 15)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map)
    
    let currentMarker = null
    let currentCircle = null
    let currentPosition = null
    
    function showCurrentLocation(lat, lon, accuracy) {
      if (currentMarker) map.removeLayer(currentMarker)
      if (currentCircle) map.removeLayer(currentCircle)
    
      const icon = L.divIcon({
        html: '<div style="width:18px;height:18px;background:#007b3a;border:2px solid white;border-radius:50%;box-shadow:0 0 6px #007b3a;"></div>',
        className: ''
      })
    
      currentMarker = L.marker([lat, lon], { icon: icon }).addTo(map)
      currentCircle = L.circle([lat, lon], {
        radius: accuracy,
        color: '#007b3a',
        fillColor: '#00ff88',
        fillOpacity: 0.15
      }).addTo(map)
    }
    
    function moveToCurrentLocation() {
      if (currentPosition) {
        map.flyTo(currentPosition, 17, { animate: true, duration: 0.3 })
      } else {
        alert('ç¾åœ¨åœ°ã‚’å–å¾—ä¸­ã§ã™ã€‚å°‘ã—ãŠå¾…ã¡ãã ã•ã„ã€‚')
      }
    }
    
    // --- ç¾åœ¨åœ°è¿½è·¡ ---
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(
        function (pos) {
          const lat = pos.coords.latitude
          const lon = pos.coords.longitude
          const acc = pos.coords.accuracy
          if (!currentPosition || Math.abs(currentPosition[0] - lat) > 0.00005 || Math.abs(currentPosition[1] - lon) > 0.00005) {
            currentPosition = [lat, lon]
            showCurrentLocation(lat, lon, acc)
          }
        },
        function (err) {
          console.warn('ä½ç½®æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', err)
        },
        { enableHighAccuracy: true, maximumAge: 5000, timeout: 5000 }
      )
    } else {
      alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚')
    }
    
    // --- ğŸ“ãƒœã‚¿ãƒ³ ---
    const locateControl = L.control({ position: 'topleft' })
    locateControl.onAdd = function () {
      const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control')
      div.innerHTML = '<a href="#" title="ç¾åœ¨åœ°ã¸ç§»å‹•" style="font-size:18px;line-height:26px;">ğŸ“</a>'
      div.style.background = 'white'
      div.style.textAlign = 'center'
      div.style.cursor = 'pointer'
      L.DomEvent.disableClickPropagation(div)
      L.DomEvent.on(div, 'click', function (e) {
        e.preventDefault()
        moveToCurrentLocation()
      })
      return div
    }
    locateControl.addTo(map)
    
    // --- åº—èˆ—ãƒãƒ¼ã‚«ãƒ¼ ---
    var stores = []
    try {
      stores = JSON.parse('{{ stores_json|default:"[]"|safe }}')
    } catch (e) {
      console.warn('stores_json parse error:', e)
    }
    
    stores.forEach(function (obj) {
      var s = obj.fields
      // lat / lng ä¸¡æ–¹ãŒæœ‰åŠ¹ãªå ´åˆã®ã¿
      if (s.lat && s.lng && s.lat !== 0 && s.lng !== 0) {
        var popup = `
              <div class="popup-content">
                <div class="store-name">${s.store_name}</div>
                ã‚«ãƒ†ã‚´ãƒªï¼š${s.category}<br>
                ä½æ‰€ï¼š${s.address}<br>
                é›»è©±ï¼š${s.tel || 'ï¼'}<br>
                å–¶æ¥­æ™‚é–“ï¼š${s.open_hours || 'ï¼'}
              </div>`
        L.marker([s.lat, s.lng]).addTo(map).bindPopup(popup)
      }
    })
    
    // --- åˆå›ä½ç½®å–å¾— ---
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        function (pos) {
          const lat = pos.coords.latitude
          const lon = pos.coords.longitude
          currentPosition = [lat, lon]
          showCurrentLocation(lat, lon, pos.coords.accuracy)
        },
        function (err) {
          console.warn('åˆå›ä½ç½®å–å¾—ã‚¨ãƒ©ãƒ¼:', err)
        },
        { enableHighAccuracy: true, timeout: 3000 }
      )
    }
  </script>
{% endblock %}
