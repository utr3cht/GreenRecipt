{% extends 'core/base.html' %}
{# Force reload #}

{% block content %}
<div class="container" style="max-width: 800px; margin: 0 auto; padding: 20px;">
    <h1 style="text-align: center; margin-bottom: 30px; color: #0f766e;">AIエコスコアレポート</h1>

    <div class="month-selector" style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 30px;">
        <a href="?year={{ year }}&month={{ month|add:'-1' }}" class="btn btn-secondary" style="padding: 5px 15px;">&lt; 前月</a>
        <span style="font-size: 1.4em; font-weight: bold; color: #333;">{{ year }}年 {{ month }}月</span>
        <a href="?year={{ year }}&month={{ month|add:'1' }}" class="btn btn-secondary" style="padding: 5px 15px;">翌月 &gt;</a>
    </div>

    <div class="report-card" style="background: #fff; padding: 30px; border-radius: 18px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 30px; border: 1px solid #e2e8f0;">
        {% if report_exists %}
            <div class="score-display" style="text-align: center; margin-bottom: 30px;">
                <h2 style="font-size: 1.2em; color: #64748b; margin-bottom: 15px;">あなたの今月のエコスコア</h2>
                <div class="score-circle" style="width: 140px; height: 140px; border-radius: 50%; background: linear-gradient(135deg, #4ade80, #22c55e); color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto; box-shadow: 0 10px 20px rgba(34, 197, 94, 0.3);">
                    <span style="font-size: 3em; font-weight: 800; line-height: 1;">{{ score }}</span>
                    <span style="font-size: 0.9em; opacity: 0.9;">/ 100</span>
                </div>
            </div>

            <div class="chart-container" style="position: relative; height: 200px; width: 100%; max-width: 400px; margin: 0 auto 30px;">
                <canvas id="scoreChart"></canvas>
            </div>
            
            <div class="report-text">
                <h3 style="color: #0f766e; border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; margin-bottom: 15px;">AIからのアドバイス</h3>
                <div style="background: #f0fdf4; padding: 20px; border-radius: 12px; border: 1px solid #bbf7d0;">
                    <p style="white-space: pre-wrap; line-height: 1.8; color: #166534; font-size: 1.05em;">{{ report_text }}</p>
                </div>
            </div>

            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const ctx = document.getElementById('scoreChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['あなた', '平均'],
                            datasets: [{
                                label: 'エコスコア',
                                data: [{{ score }}, {{ average_score }}],
                                backgroundColor: [
                                    'rgba(34, 197, 94, 0.8)',
                                    'rgba(148, 163, 184, 0.5)'
                                ],
                                borderRadius: 8,
                                barThickness: 40
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return context.raw + '点';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    grid: { display: false }
                                },
                                x: {
                                    grid: { display: false }
                                }
                            }
                        }
                    });
                });
            </script>
        {% else %}
            <div style="text-align: center; padding: 40px 0;">
                <h2 style="color: #64748b; margin-bottom: 20px;">今月のレポートはまだ作成されていません</h2>
                <p style="color: #94a3b8; margin-bottom: 30px;">ボタンを押すと、AIがあなたの購入履歴を分析してエコスコアとアドバイスを作成します。</p>
                <form method="post">
                    {% csrf_token %}
                    <button type="submit" name="generate" class="btn btn-primary" style="padding: 15px 40px; font-size: 1.2em; border-radius: 50px; background: linear-gradient(135deg, #0ea5e9, #22c55e); border: none; box-shadow: 0 10px 25px rgba(34, 197, 94, 0.4); transition: transform 0.2s;">
                        レポートを作成する
                    </button>
                </form>
            </div>
        {% endif %}
    </div>

    <div class="product-list-section">
        <h3 style="color: #334155; margin-bottom: 15px;">今月の購入商品</h3>
        {% if purchased_products %}
            <ul class="list-group" style="border-radius: 12px; overflow: hidden; border: 1px solid #e2e8f0;">
                {% for product in purchased_products %}
                    <li class="list-group-item" style="border: none; border-bottom: 1px solid #f1f5f9; padding: 12px 20px;">{{ product }}</li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="alert alert-info" style="text-align: center;">今月の購入履歴がありません。</div>
        {% endif %}
    </div>
</div>
{% endblock %}