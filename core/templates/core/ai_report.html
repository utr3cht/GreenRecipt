{% extends 'core/base.html' %}
{# Force reload #}

{% block content %}
<div class="container" style="max-width: 900px; margin: 0 auto; padding: 40px 20px;">
    <h1 style="text-align: center; margin-bottom: 40px; color: #065f46; font-weight: 700; letter-spacing: -0.025em;">AIエコスコアレポート</h1>

    <!-- Month Navigation -->
    <div class="month-selector" style="display: flex; justify-content: center; align-items: center; gap: 30px; margin-bottom: 50px; background: white; padding: 15px 30px; border-radius: 50px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); width: fit-content; margin-left: auto; margin-right: auto;">
        <a href="?year={{ year }}&month={{ month|add:'-1' }}" class="nav-btn" style="text-decoration: none; color: #4b5563; font-weight: 500; transition: color 0.2s;">
            <i class="fas fa-chevron-left"></i> 前月
        </a>
        <span style="font-size: 1.5em; font-weight: 800; color: #1f2937; min-width: 180px; text-align: center;">
            {{ year }}年 <span style="color: #059669;">{{ month }}月</span>
        </span>
        {% if is_latest_month %}
            <span class="nav-btn disabled" style="color: #d1d5db; cursor: not-allowed; font-weight: 500;">
                翌月 <i class="fas fa-chevron-right"></i>
            </span>
        {% else %}
            <a href="?year={{ year }}&month={{ month|add:'1' }}" class="nav-btn" style="text-decoration: none; color: #4b5563; font-weight: 500; transition: color 0.2s;">
                翌月 <i class="fas fa-chevron-right"></i>
            </a>
        {% endif %}
    </div>

    <div class="report-content" style="display: grid; gap: 30px;">
        
        <!-- Score Section -->
        {% if report_exists %}
            <div class="report-card main-card" style="background: white; border-radius: 24px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.01); overflow: hidden;">
                <div class="card-header" style="background: linear-gradient(to right, #ecfdf5, #f0fdf4); padding: 20px; text-align: center; border-bottom: 1px solid #d1fae5;">
                    <h2 style="margin: 0; color: #065f46; font-size: 1.1em; font-weight: 600;">今月のエコ達成度</h2>
                </div>
                
                <div class="card-body" style="padding: 40px; text-align: center;">
                    <div class="score-container" style="position: relative; width: 200px; height: 200px; margin: 0 auto 30px;">
                        <!-- Using a conic gradient for a chart-like effect based on score -->
                        <div class="score-ring" style="width: 100%; height: 100%; border-radius: 50%; background: conic-gradient(#059669 {{ score }}%, #e5e7eb {{ score }}%); display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);">
                            <div class="inner-circle" style="width: 85%; height: 85%; background: white; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                <span class="score-value" style="font-size: 4em; font-weight: 800; line-height: 1; color: #059669;">{{ score }}</span>
                                <span class="score-label" style="color: #6b7280; font-size: 0.9em; font-weight: 600; margin-top: 5px;">POINTS</span>
                            </div>
                        </div>
                    </div>

                    <!-- Chart Section -->
                    <div class="chart-wrapper" style="max-width: 500px; margin: 0 auto;">
                        <canvas id="scoreChart" height="200"></canvas>
                    </div>
                </div>
            </div>
            <!-- Stats Row -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- Rank Card -->
                <div class="report-card" style="background: white; border-radius: 20px; padding: 25px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); text-align: center; border: 1px solid #e5e7eb;">
                    <div style="color: #6b7280; font-size: 0.9em; font-weight: 600; margin-bottom: 10px;">今月のランク</div>
                    <div style="color: #059669; font-size: 1.4em; font-weight: 800;">{{ rank }}</div>
                </div>
                
                <!-- Monthly Points Card -->
                <div class="report-card" style="background: white; border-radius: 20px; padding: 25px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); text-align: center; border: 1px solid #e5e7eb;">
                    <div style="color: #6b7280; font-size: 0.9em; font-weight: 600; margin-bottom: 10px;">月間獲得ポイント</div>
                    <div style="color: #059669; font-size: 1.4em; font-weight: 800;">{{ monthly_points }} pt</div>
                </div>
            </div>


            <!-- Advice Section -->
            <div class="report-card advice-card" style="background: white; border-radius: 24px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05); overflow: hidden; border: 1px solid #e5e7eb;">
                <div class="card-body" style="padding: 30px;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                         <div style="background: #dcfce7; padding: 10px; border-radius: 12px; color: #166534;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                        </div>
                        <h3 style="margin: 0; font-size: 1.25em; font-weight: 700; color: #1f2937;">AIからのアドバイス</h3>
                    </div>
                    <div class="advice-content" style="background: #f9fafb; padding: 25px; border-radius: 16px; border-left: 5px solid #059669; color: #374151; line-height: 1.8; font-size: 1.05em;">
                        {{ report_text|linebreaksbr }}
                    </div>
                </div>
            </div>

            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const ctx = document.getElementById('scoreChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'bar', // Changed from line to bar for comparison
                        data: {
                            labels: ['あなたのスコア', '平均スコア'],
                            datasets: [{
                                label: 'エコスコア',
                                data: [{{ score }}, {{ average_score }}],
                                backgroundColor: [
                                    'rgba(16, 185, 129, 0.8)', // Emerald 500
                                    'rgba(209, 213, 219, 0.8)'  // Gray 300
                                ],
                                borderRadius: 8,
                                barPercentage: 0.5,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: '#1f2937',
                                    padding: 12,
                                    titleFont: { size: 13 },
                                    bodyFont: { size: 14 },
                                    cornerRadius: 8,
                                    callbacks: {
                                        label: function(context) {
                                            return context.raw + '点';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    grid: {
                                        color: '#f3f4f6',
                                        drawBorder: false,
                                    },
                                    ticks: { font: { family: "'Inter', sans-serif" } }
                                },
                                x: {
                                    grid: { display: false },
                                    ticks: { font: { family: "'Inter', sans-serif", weight: '600' } }
                                }
                            }
                        }
                    });
                });
            </script>

        {% else %}
            <!-- Empty State -->
            <div class="empty-state" style="text-align: center; padding: 60px 20px; background: white; border-radius: 24px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);">
                <div style="background: #f0fdf4; width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; color: #059669;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 10 10 4 4 0 0 1-5-5 4 4 0 0 1-5-5c3.2 0 5.2 2.3 6 4a10 10 0 0 0-6-4z"></path></svg>
                </div>
                <h2 style="color: #1f2937; font-weight: 700; margin-bottom: 15px;">レポート未作成</h2>
                <p style="color: #6b7280; max-width: 400px; margin: 0 auto 30px; line-height: 1.6;">
                    今月の購入履歴をAIが分析し、あなただけの<br>エコスコアとアドバイスを作成します。
                </p>
                <form method="post">
                    {% csrf_token %}
                    <button type="submit" name="generate" class="btn-generate" style="background: #059669; color: white; border: none; padding: 16px 40px; font-size: 1.1em; font-weight: 600; border-radius: 12px; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(5, 150, 105, 0.3);">
                        レポートを作成する
                    </button>
                </form>
            </div>
        {% endif %}

        <!-- Product List -->
        <div class="product-section" style="margin-top: 20px;">
            <h3 style="color: #374151; font-size: 1.1em; font-weight: 600; margin-bottom: 20px; padding-left: 10px; border-left: 4px solid #059669;">
                今月の購入商品履歴
            </h3>
            
            {% if purchased_products %}
                <div class="product-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                    {% for product in purchased_products %}
                        <div class="product-item" style="background: white; padding: 15px; border-radius: 12px; border: 1px solid #e5e7eb; font-size: 0.95em; color: #4b5563;">
                            {{ product }}
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="no-data" style="background: #f9fafb; border-radius: 12px; padding: 30px; text-align: center; color: #6b7280; border: 2px dashed #e5e7eb;">
                    購入履歴がありません
                </div>
            {% endif %}
        </div>
        
    </div>
</div>

<style>
    .nav-btn:hover:not(.disabled) {
        color: #059669 !important;
    }
    .btn-generate:hover {
        background: #047857 !important;
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(5, 150, 105, 0.4) !important;
    }
    @media (max-width: 600px) {
        .month-selector {
            gap: 15px !important;
            padding: 10px 20px !important;
        }
        .score-container {
            width: 150px !important;
            height: 150px !important;
        }
        .score-value {
            font-size: 3em !important;
        }
    }
</style>
{% endblock %}