{% extends 'core/base.html' %}
{% load static %}
{# Force reload #}

{% block title %}AIã‚¨ã‚³ã‚¹ã‚³ã‚¢ãƒ¬ãƒãƒ¼ãƒˆ | GreenReceipt{% endblock %}

{% block extra_css %}
<style>
  .report-page {
    max-width: 900px;
    margin: 0 auto;
    width: 100%;
    padding-bottom: 80px; /* nav bar space */
  }

  .report-title {
    text-align: center;
    margin-bottom: 30px;
    color: #065f46;
    font-weight: 700;
    font-size: 1.5rem;
  }

  /* Month Selector */
  .month-selector {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    margin-bottom: 40px;
    background: #fff;
    padding: 12px 24px;
    border-radius: 50px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    width: fit-content;
    margin-left: auto;
    margin-right: auto;
    border: 1px solid #e2e8f0;
  }
  
  .nav-btn {
    text-decoration: none;
    color: #64748b;
    font-weight: 600;
    transition: color 0.2s;
    font-size: 0.95rem;
  }
  .nav-btn:hover { color: #059669; }
  .nav-btn.disabled { color: #cbd5e1; cursor: default; }
  
  .current-month {
    font-size: 1.2rem;
    font-weight: 800;
    color: #1f2937;
    min-width: 140px;
    text-align: center;
  }
  .current-month span { color: #059669; }

  /* Report Card */
  .report-card {
    background: #fff;
    border-radius: 24px;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
    border: 1px solid #e2e8f0;
    overflow: hidden;
    margin-bottom: 24px;
  }

  .card-header {
    background: linear-gradient(to right, #ecfdf5, #f0fdf4);
    padding: 20px;
    text-align: center;
    border-bottom: 1px solid #d1fae5;
  }
  .card-header h2 {
    margin: 0;
    color: #065f46;
    font-size: 1.1rem;
    font-weight: 700;
  }

  .card-body { padding: 30px; }

  /* Score Ring */
  .score-container {
    position: relative;
    width: 200px;
    height: 200px;
    margin: 0 auto 30px;
  }
  .score-ring {
    width: 100%; height: 100%;
    border-radius: 50%;
    background: conic-gradient(#059669 {{ score }}%, #e5e7eb {{ score }}%);
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
  }
  .inner-circle {
    width: 85%; height: 85%;
    background: white;
    border-radius: 50%;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
  }
  .score-value {
    font-size: 4em; font-weight: 800; line-height: 1; color: #059669;
  }
  .score-label {
    color: #6b7280; font-size: 0.9em; font-weight: 600; margin-top: 5px;
  }

  /* Stats Grid */
  .stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 24px;
  }
  .stat-card {
    background: #fff;
    border-radius: 20px;
    padding: 20px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    text-align: center;
    border: 1px solid #e2e8f0;
  }
  .stat-label { color: #64748b; font-size: 0.9em; font-weight: 600; margin-bottom: 8px; }
  .stat-value { color: #059669; font-size: 1.3em; font-weight: 800; }

  /* Advice */
  .advice-header {
    display: flex; align-items: center; gap: 12px; margin-bottom: 16px;
  }
  .advice-icon {
    background: #dcfce7; padding: 8px; border-radius: 12px; color: #166534;
    display: flex; align-items: center; justify-content: center;
  }
  .advice-content {
    background: #f9fafb; padding: 20px; border-radius: 16px;
    border-left: 5px solid #059669; color: #374151; line-height: 1.8;
  }

  /* Empty State - Centered */
  .empty-state-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 400px; /* Ensure vertical space clearly */
    text-align: center;
    background: #fff;
    border-radius: 24px;
    padding: 40px 20px;
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
    border: 1px solid #e2e8f0;
    margin-top: 20px;
  }
  
  .empty-icon-circle {
    background: #f0fdf4;
    width: 90px; height: 90px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    margin-bottom: 24px;
    color: #059669;
  }
  
  .empty-title {
    color: #1f2937; font-weight: 700; font-size: 1.5rem; margin-bottom: 12px;
  }
  
  .empty-desc {
    color: #6b7280; max-width: 400px; line-height: 1.6; margin-bottom: 32px;
  }
  
  .btn-generate {
    background: linear-gradient(135deg, #059669, #10b981);
    color: white; border: none;
    padding: 16px 48px;
    font-size: 1.15em; font-weight: 700;
    border-radius: 50px;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 10px 20px rgba(5, 150, 105, 0.2);
    display: inline-flex; align-items: center; gap: 8px;
  }
  .btn-generate:hover {
    transform: translateY(-2px);
    box-shadow: 0 14px 24px rgba(5, 150, 105, 0.3);
  }

  /* Product Grid */
  .product-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;
  }
  .product-item {
    background: white; padding: 15px; border-radius: 12px; border: 1px solid #e5e7eb; font-size: 0.95em; color: #4b5563;
  }
  .no-data {
    background: #f9fafb; border-radius: 12px; padding: 30px; text-align: center; color: #6b7280; border: 2px dashed #e5e7eb;
  }
</style>
{% endblock %}

{% block content %}
<div class="report-page">
    <h1 class="report-title">AIã‚¨ã‚³ã‚¹ã‚³ã‚¢ãƒ¬ãƒãƒ¼ãƒˆ</h1>

    <!-- Month Navigation -->
    <div class="month-selector">
        <a href="?year={{ year }}&month={{ month|add:'-1' }}" class="nav-btn">
             &lt; å‰æœˆ
        </a>
        <span class="current-month">
            {{ year }}å¹´ <span>{{ month }}æœˆ</span>
        </span>
        {% if is_latest_month %}
            <span class="nav-btn disabled">
                ç¿Œæœˆ &gt;
            </span>
        {% else %}
            <a href="?year={{ year }}&month={{ month|add:'1' }}" class="nav-btn">
                ç¿Œæœˆ &gt;
            </a>
        {% endif %}
    </div>

    {% if report_exists %}
        <div class="report-content">
            
            <!-- Score Card -->
            <div class="report-card">
                <div class="card-header">
                    <h2>ä»Šæœˆã®ã‚¨ã‚³é”æˆåº¦</h2>
                </div>
                <div class="card-body">
                    <div class="score-container">
                        <div class="score-ring">
                            <div class="inner-circle">
                                <span class="score-value">{{ score }}</span>
                                <span class="score-label">POINTS</span>
                            </div>
                        </div>
                    </div>

                    <div style="max-width: 500px; margin: 0 auto;">
                        <canvas id="scoreChart" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">ç¾åœ¨ã®ãƒ©ãƒ³ã‚¯</div>
                    <div class="stat-value">{{ rank }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æœˆé–“ç²å¾—ãƒã‚¤ãƒ³ãƒˆ</div>
                    <div class="stat-value">{{ held_points }} pt</div>
                </div>
            </div>

            <!-- Advice -->
            <div class="report-card">
                <div class="card-body">
                    <div class="advice-header">
                         <div class="advice-icon">
                            ğŸ’¡
                        </div>
                        <h3 style="margin:0; font-size: 1.1rem; font-weight:700;">AIã‹ã‚‰ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹</h3>
                    </div>
                    <div class="advice-content">
                        {{ report_text|linebreaksbr }}
                    </div>
                    {% if is_latest_month %}
                        <div style="margin-top: 20px; text-align: right;">
                            <form method="post" style="display: inline; background:none; border:none; padding:0; box-shadow:none;">
                                {% csrf_token %}
                                <button type="submit" name="generate" class="btn btn-sm" style="background:#059669; color:white;">
                                    ãƒ¬ãƒãƒ¼ãƒˆã‚’æ›´æ–°ã™ã‚‹
                                </button>
                            </form>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- JavaScript -->
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script id="chart-data" type="application/json">
            {
                "score": {{ score|default:0 }},
                "average_score": {{ average_score|default:0 }}
            }
            </script>
            <script src="{% static 'js/ai_report.js' %}?v=1.0"></script>
        </div>

    {% else %}
        <!-- Empty State -->
        <div class="empty-state-wrapper">
            <div class="empty-icon-circle">
                <span style="font-size: 40px;">ğŸ“Š</span>
            </div>
            <h2 class="empty-title">{% if is_latest_month %}ãƒ¬ãƒãƒ¼ãƒˆæœªä½œæˆ{% else %}ãƒ¬ãƒãƒ¼ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“{% endif %}</h2>
            <p class="empty-desc">
                {% if is_latest_month %}
                    ä»Šæœˆã®è³¼å…¥å±¥æ­´ã‚’AIãŒåˆ†æã—ã€<br>ã‚ãªãŸã ã‘ã®ã‚¨ã‚³ã‚¹ã‚³ã‚¢ã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚
                {% else %}
                    ã“ã®æœˆã®ãƒ¬ãƒãƒ¼ãƒˆã¯ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br>éå»ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’é¡ã£ã¦ç”Ÿæˆã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
                {% endif %}
            </p>
            {% if is_latest_month %}
                <form method="post">
                    {% csrf_token %}
                    <button type="submit" name="generate" class="btn-generate">
                        ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã™ã‚‹
                    </button>
                </form>
            {% endif %}
        </div>
    {% endif %}

    <!-- Product List -->
    <div style="margin-top: 40px;">
        <h3 style="font-size: 1.1em; font-weight: 600; margin-bottom: 20px; padding-left: 10px; border-left: 4px solid #059669; color: #374151;">
            ä»Šæœˆã®è³¼å…¥å•†å“å±¥æ­´
        </h3>
        
        {% if purchased_products %}
            <div class="product-grid">
                {% for product in purchased_products %}
                    <div class="product-item">
                        {{ product }}
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="no-data">
                è³¼å…¥å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}