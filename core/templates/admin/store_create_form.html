{% extends "admin/admin_base.html" %}

{% block title %}
  店舗登録
{% endblock %}

{% block content %}
  <div class="main-content">
    <h1>店舗登録</h1>
    <form method="post">
      {% csrf_token %}
      
      <h2>店舗情報</h2>
      {{ store_form.as_p }}

      <hr>

      <h2>店舗アカウント登録</h2>
      <p>店舗と同時に新しいアカウントを登録します。</p>
      {% for field in user_form.visible_fields %}
        <div class="form-group">
          {{ field.label_tag }}
          {% if field.name == 'password1' or field.name == 'password2' %}
            <div class="password-container">
              {{ field }}
              <button type="button" class="toggle-password" onclick="togglePasswordVisibility(this, '{{ field.id_for_label }}')" title="パスワードの表示/非表示を切り替える">表示</button>
            </div>
          {% else %}
            {{ field }}
          {% endif %}
          {% if field.help_text %}
            <small class="form-text text-muted">{{ field.help_text }}</small>
          {% endif %}
          {% for error in field.errors %}
            <div class="alert alert-danger">{{ error }}</div>
          {% endfor %}
        </div>
      {% endfor %}

      <script>
        function togglePasswordVisibility(button, fieldId) {
          var passwordField = document.getElementById(fieldId);
          if (passwordField.type === "password") {
            passwordField.type = "text";
            button.textContent = "非表示";
          } else {
            passwordField.type = "password";
            button.textContent = "表示";
          }
        }
      </script>

      <div class="actions">
        <button type="submit" class="btn btn-primary">登録</button>
        <a href="{% url 'core:store_list' %}" class="btn btn-secondary">キャンセル</a>
      </div>
    </form>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
        const usernameField = document.getElementById('id_username');
        const emailField = document.getElementById('id_email');
        const submitBtn = document.querySelector('button[type="submit"]');
    
        function updateSubmitButton() {
            // Check if any field has is-invalid class
            const hasError = document.querySelectorAll('.is-invalid').length > 0;
            submitBtn.disabled = hasError;
        }
    
        function checkAvailability(field, value, element) {
            if (!value) return;
            
            // Clear previous custom error
            const errorDiv = element.parentNode.querySelector('.invalid-feedback-custom');
            if (errorDiv) errorDiv.remove();
            element.classList.remove('is-invalid');
            
            updateSubmitButton();
    
            fetch(`/accounts/check-availability/?field=${field}&value=${encodeURIComponent(value)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.is_taken) {
                        const errorMsg = document.createElement('div');
                        errorMsg.className = 'invalid-feedback-custom text-danger alert alert-danger mt-2';
                        errorMsg.textContent = data.error_message;
                        element.parentNode.appendChild(errorMsg);
                        element.classList.add('is-invalid');
                    }
                })
                .catch(error => console.error('Error:', error))
                .finally(() => {
                    updateSubmitButton();
                });
        }
    
        if (usernameField) {
            usernameField.addEventListener('blur', function() {
                checkAvailability('username', this.value, this);
            });
            usernameField.addEventListener('input', function() {
                 const errorDiv = this.parentNode.querySelector('.invalid-feedback-custom');
                 if (errorDiv) errorDiv.remove();
                 this.classList.remove('is-invalid');
                 updateSubmitButton();
            });
        }
    
        if (emailField) {
            emailField.addEventListener('blur', function() {
                 checkAvailability('email', this.value, this);
            });
            emailField.addEventListener('input', function() {
                 const errorDiv = this.parentNode.querySelector('.invalid-feedback-custom');
                 if (errorDiv) errorDiv.remove();
                 this.classList.remove('is-invalid');
                 updateSubmitButton();
            });
        }
    });
  </script>
{% endblock %}