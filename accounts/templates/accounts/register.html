{% extends 'core/base.html' %}
{% load static %}

{% block title %}新規登録 | GreenReceipt{% endblock %}

{% block content %}
<form method="post" action="{% url 'accounts:register' %}" class="full">
  {% csrf_token %}

  {% for field in form.visible_fields %}
    <div class="form-group">
      {{ field.label_tag }}
      {% if field.name == 'password1' or field.name == 'password2' %}
        <div class="password-container">
          {{ field }}
          <button type="button" class="toggle-password" data-target="{{ field.id_for_label }}" title="パスワードの表示/非表示を切り替える">表示</button>
        </div>
      {% else %}
        {{ field }}
      {% endif %}
      {% if field.help_text %}
        <small class="form-text text-muted list-none">{{ field.help_text }}</small>
      {% endif %}
      {% for error in field.errors %}
        <div class="alert alert-danger" >{{ error }}</div>
      {% endfor %}
    </div>
  {% endfor %}

  <div class="actions" style="text-align:center;">
    <a href="{% url 'core:index' %}" class="btn btn-neutral">戻る</a>
    <button type="submit">確認</button>
  </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const usernameField = document.getElementById('id_username');
    const emailField = document.getElementById('id_email');
    const submitBtn = document.querySelector('button[type="submit"]');

    function updateSubmitButton() {
        // Check if any field has is-invalid class
        const hasError = document.querySelectorAll('.is-invalid').length > 0;
        submitBtn.disabled = hasError;
    }

    function checkAvailability(field, value, element) {
        if (!value) return;
        
        // Clear previous custom error
        const errorDiv = element.parentNode.querySelector('.invalid-feedback-custom');
        if (errorDiv) errorDiv.remove();
        element.classList.remove('is-invalid');
        
        // Check status immediately (cleared error might make it valid)
        updateSubmitButton();

        fetch(`/accounts/check-availability/?field=${field}&value=${encodeURIComponent(value)}`)
            .then(response => response.json())
            .then(data => {
                if (data.is_taken) {
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'invalid-feedback-custom text-danger';
                    errorMsg.style.fontSize = '0.875em';
                    errorMsg.style.marginTop = '0.25rem';
                    errorMsg.textContent = data.error_message;
                    element.parentNode.appendChild(errorMsg);
                    element.classList.add('is-invalid');
                }
            })
            .catch(error => console.error('Error:', error))
            .finally(() => {
                updateSubmitButton();
            });
    }

    if (usernameField) {
        usernameField.addEventListener('blur', function() {
            checkAvailability('username', this.value, this);
        });
        // Clear error on input to avoid getting stuck
        usernameField.addEventListener('input', function() {
             const errorDiv = this.parentNode.querySelector('.invalid-feedback-custom');
             if (errorDiv) errorDiv.remove();
             this.classList.remove('is-invalid');
             updateSubmitButton();
        });
    }

    if (emailField) {
        emailField.addEventListener('blur', function() {
             checkAvailability('email', this.value, this);
        });
        emailField.addEventListener('input', function() {
             const errorDiv = this.parentNode.querySelector('.invalid-feedback-custom');
             if (errorDiv) errorDiv.remove();
             this.classList.remove('is-invalid');
             updateSubmitButton();
        });
    }
});
</script>
{% endblock %}
